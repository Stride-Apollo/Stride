<head>
	<script src='https://api.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
	<script src='ProcessData.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
	<div id="map" style="width: 100%; height: 100%"></div>

	<button onclick="previousDay()">Previous day</button>
	<button onclick="nextDay()">Next day</button>
	<script src='https://npmcdn.com/@turf/turf/turf.min.js' charset='utf-8'></script>
	<script>
	mapboxgl.accessToken = 'pk.eyJ1Ijoid29la2lraSIsImEiOiJjajJnNnhnOTcwMDBtNDBuMDltc3BreGZpIn0.kPsej_9LZ3cEaggCD8py9w';
	var map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/mapbox/streets-v9'
	});
	var files = [];	// file-text_of_file pairs

	var currentDay = 0;

	var fs = require('fs');
	fs.readFile(__dirname + "/data/config.json", 'utf8', function (err, data) {
		if (err) return console.log(err);
		var config = JSON.parse(data);

		fs.readdir(__dirname + "/" + config.directory, function(err, content){
			if (err) {
				return console.error(err);
			}

			content.forEach( function (file){
				var data = fs.readFileSync(__dirname + "/" + config.directory + "/" + file, 'utf8');
				files.push(data);
			});
			map.on('load', function() {
				makeClusters(JSON.parse(files[currentDay]));
			});
		});

	});

	function nextDay() {
	    if (++currentDay >= files.length) {
	        currentDay--;
        } else {
	    	map.getSource("cluster_data").setData(parseData(JSON.parse(files[currentDay])))
        }
    }

	function previousDay() {
		if (--currentDay < 0) {
		    currentDay = 0;
		} else {
            map.getSource("cluster_data").setData(parseData(JSON.parse(files[currentDay])))
        }
	}

	function parseData(cluster_data) {
		for (var i in cluster_data.features) {
			cluster_data.features[i].properties.infected_percent = parseFloat(cluster_data.features[i].properties.infected_percent);
			cluster_data.features[i].properties.infected = parseFloat(cluster_data.features[i].properties.infected);
			cluster_data.features[i].properties.size = parseFloat(cluster_data.features[i].properties.size);
			cluster_data.features[i].geometry.coordinates = [parseFloat(cluster_data.features[i].geometry.coordinates[0]), parseFloat(cluster_data.features[i].geometry.coordinates[1])];
		}
		return cluster_data;
	}

	function makeClusters(cluster_data) {
		// preparsing
		cluster_data = parseData(cluster_data);

		map.addSource("cluster_data", {
			"type": "geojson",
			"data": cluster_data
		});

		map.addLayer({
			"id": "clusters",
			"type": "circle",
			"source": "cluster_data",
			"paint": {
				'circle-radius': {
					property: "size",
					type: "interval",
					stops: getSize(cluster_data)
				},
				"circle-color": {
					property: "infected_percent",
					stops: [[-1, 'rgb(0, 250,0)'],[0, 'rgb(250, 250,0)'],[1, 'rgb(250,0,0)']]
				},
				"circle-opacity": 0.9
			}
		});
		// Create a popup, but don't add it to the map yet.
		var popup = new mapboxgl.Popup({
			closeButton: false,
			closeOnClick: false
		});

		map.on('mouseenter', 'clusters', function(e) {
			// Change the cursor style as a UI indicator.

			var coords = e.features[0].geometry.coordinates;
			map.getCanvas().style.cursor = 'pointer';

			var htmlText = "Cluster " + e.features[0].properties.id.toString()
			+ "<br>Size: " + e.features[0].properties.size.toString()
			+ "<br>Infected: " + e.features[0].properties.infected.toString()
			+ "<br>Coordinates: (" + coords[0] + ", " + coords[1] + ")";

			// Populate the popup and set its coordinates
			// based on the feature found.
			popup.setLngLat(coords)
				.setHTML(htmlText)
				.addTo(map);
		});

		map.on('mouseleave', 'clusters', function() {
			map.getCanvas().style.cursor = '';
			popup.remove();
		});

		var windows = []
		map.on('click', 'clusters', function(e) {
			console.log(e.features[0].properties.id);
			const electron = require('electron').remote;
			const BrowserWindow = electron.BrowserWindow;

			if (!containsWin(windows, e.features[0].properties.id)) {
				var win = new BrowserWindow({ width: 800, height: 600 });

				windows.push({id:e.features[0].properties.id, win: win });
				win.webContents.on('did-finish-load', ()=>{
					win.show();
					win.focus();
				});

				win.on('closed', function () {
					for (var i in windows) {
						if (windows[i].id == e.features[0].properties.id) {

							windows.splice(i, 1);
						}
					}
				})
				win.loadURL("https://www.google.be/search?q=how+to+code&oq=how+to+code&aqs=chrome.0.69i59j0l5.3375j0j7&sourceid=chrome&ie=UTF-8");
			} else {
				for (var i in windows) {
					if (windows[i].id == e.features[0].properties.id) {
						windows[i].win.focus();
					}
				}
			}
		});

		fitView(map, cluster_data);
	}

	function fitView(map, cluster_data) {
		var coords = [];
		for (var i in cluster_data.features) {
			coords.push(cluster_data.features[i].geometry.coordinates);
		};

		var min_lat = Number.MAX_VALUE;
		var max_lat = Number.MIN_VALUE;
		var min_lon = Number.MAX_VALUE;
		var max_lon = Number.MIN_VALUE;
		for (var i in coords) {
			if (coords[i][0] > max_lon) {
				max_lon = coords[i][0];
			};
			if (coords[i][0] < min_lon) {
				min_lon = coords[i][0];
			};
			if (coords[i][1] > max_lat) {
				max_lat = coords[i][1];
			};
			if (coords[i][1] < min_lat) {
				min_lat = coords[i][1];
			};
		};
		console.log("(" + min_lon + ", " + min_lat + ")" + "(" + max_lon + ", " + max_lat + ")");
		map.fitBounds([[min_lon-2, min_lat-2], [max_lon+2, max_lat+2]]);
	}

	function getSize(cluster_data) {
		var result = [[{zoom: 0, value:0}, 0]];
		//var result = [[0, 0]];
		var orig_MIN_SIZE = 1;
		var orig_MAX_SIZE = 3;
		var min_value = Number.MAX_VALUE;
		var max_value = Number.MIN_VALUE;

		for (var i in cluster_data.features) {
			var size = cluster_data.features[i].properties.size;
			if (size > max_value) {
				max_value = size;
			}
			if (size < min_value) {
				min_value = size;
			}
		};

		var zoom = [[1,1], [4,1], [7,2], [13, 4], [15, 7], [18, 10]];
		var sizes = [];
		for (var i in cluster_data.features) {
			sizes.push(cluster_data.features[i].properties.size);
		};

		sizes.sort();

		/*for (var i in sizes) {
			result.push([sizes[i], ((sizes[i] - min_value)*(orig_MAX_SIZE - orig_MIN_SIZE)/(max_value - min_value) + orig_MIN_SIZE)]);
		}
		console.log(result);
		return result;*/

		var tempresult = {};
		for (var i in zoom) {
			tempresult[i] = [];
			for (var j in sizes) {
				var size = {};
				size.zoom = zoom[i][0];
				size.value = sizes[j];
				var MAX_SIZE = orig_MAX_SIZE * zoom[i][1];
				var MIN_SIZE = orig_MIN_SIZE * zoom[i][1];
				console.log(size);
				console.log(((sizes[j] - min_value)*(MAX_SIZE - MIN_SIZE)/(max_value - min_value) + MIN_SIZE));
				tempresult[i].push([size.value, ((sizes[j] - min_value)*(MAX_SIZE - MIN_SIZE)/(max_value - min_value) + MIN_SIZE)]);
			}
		};
		for (var i in tempresult) {
			tempresult[i].sort(function(a,b) {return a[1] - b[1]});
			for (var j in tempresult[i]) {
				var leftStop = {};
				leftStop.zoom = parseInt(i);
				leftStop.value = tempresult[i][j][0];
				result.push([leftStop, tempresult[i][j][1]]);
			}
		}
		console.log(result);
		return result;
	};

	function containsWin(array, obj) {
		var i = array.length;
		while (i--) {
			if (array[i].id === obj) {
				return true;
			}
		}
		return false;
	}
</script>
</body>
